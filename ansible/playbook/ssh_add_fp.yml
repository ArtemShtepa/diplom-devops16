- name: Wait for all instances ready
  hosts: localhost
  tasks:
    - name: Get information from YC CLI
      ansible.builtin.shell: "yc compute instance list --format json | jq -r '.[] | .status'"
      delegate_to: localhost
      register: yci_res
      until:
        - yci_res.stdout_lines | unique | count == 1
        - yci_res.stdout_lines[0] == 'RUNNING'
      retries: 10
      delay: 20

- name: Approve SSH fingerprint
  gather_facts: false
  hosts: all
  tasks:
    - name: Skip question for adding host key
      ansible.builtin.set_fact:
        ansible_ssh_common_args: "{{ ansible_ssh_common_args }} -o StrictHostKeyChecking=no"
    - name: Wait for instances ready
      ansible.builtin.setup:
        gather_timeout: 20
