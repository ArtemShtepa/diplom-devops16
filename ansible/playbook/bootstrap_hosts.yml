---
- name: Add kubernetes hosts
  tags:
    - sudo
  ansible.builtin.import_playbook: dynamic_inv.yml

- name: Install sudo package with root
  hosts: all
  tags:
    - never
    - sudo
  vars:
    ansible_ssh_common_args: ""
  tasks:
    - name: Save user name
      set_fact:
        remote_user: "{{ ansible_user }}"
    - name: Change SSH user
      set_fact:
        ansible_user: root
    - name: Install sudo to allow become
      ansible.builtin.package:
        name: sudo
        state: present
    - name: Disable password prompt
      ansible.builtin.copy:
        dest: "/etc/sudoers.d/{{ remote_user }}"
        content: "{{ remote_user }} ALL=(ALL:ALL) NOPASSWD:ALL"
    - name: Update hostname from playbook
      become: true
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"

- name: Bootstrap machines
  hosts: all
  become: true
  tasks:
    - name: Update package cache with universal module
      ansible.builtin.package:
        update_cache: true
    - name: Update hosts file
      ansible.builtin.blockinfile:
        dest: /etc/hosts
        block: |
          {% for item in groups['all'] %}
          {{ hostvars[item]['ansible_host'] }} {{ item }}
          {% endfor %}
        state: present
...
